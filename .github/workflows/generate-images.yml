name: Generate Exercise Images

# Manually triggered from the Actions tab.
#
# Provider credentials (set in repo Settings → Secrets → Actions):
#   gemini      → GEMINI_API_KEY
#   huggingface → HF_TOKEN          (free at huggingface.co/settings/tokens)
#   pollinations → (no secret needed, completely free)
on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Image generation provider'
        required: false
        default: 'pollinations'
        type: choice
        options:
          - pollinations
          - huggingface
          - gemini
      exercise:
        description: 'Exercise to generate (all = every exercise)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - pushUp
          - squat
          - pullUp
          - legRaise
          - bridge
          - handstand
      steps:
        description: 'Step numbers (e.g. "1,6,9" or "6-10" or "1-3,8" — blank = all steps)'
        required: false
        default: ''
        type: string
      overwrite:
        description: 'Overwrite existing images for the selected exercise/steps'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

permissions:
  contents: write   # needed to push generated images back to the repo

jobs:
  generate:
    name: >-
      [${{ github.event.inputs.provider }}]
      ${{ github.event.inputs.exercise == 'all' && 'all exercises' || github.event.inputs.exercise }}
      ${{ github.event.inputs.steps != '' && format('steps {0}', github.event.inputs.steps) || '(all steps)' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pillow

      - name: Generate images
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          HF_TOKEN:       ${{ secrets.HF_TOKEN }}
        run: |
          python3 scripts/generate_images.py \
            --provider  "${{ github.event.inputs.provider }}" \
            --exercise  "${{ github.event.inputs.exercise }}" \
            --steps     "${{ github.event.inputs.steps }}" \
            ${{ github.event.inputs.overwrite == 'yes' && '--overwrite' || '' }}

      - name: Commit and push generated images
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/images/exercises/
          if git diff --cached --quiet; then
            echo "No new images to commit."
          else
            COUNT=$(git diff --cached --name-only | wc -l)
            PROVIDER="${{ github.event.inputs.provider }}"
            EXERCISE="${{ github.event.inputs.exercise }}"
            STEPS="${{ github.event.inputs.steps }}"
            MSG="Generate ${COUNT} images via ${PROVIDER}"
            [ "$EXERCISE" != "all" ] && MSG="${MSG} [${EXERCISE}]"
            [ -n "$STEPS" ] && MSG="${MSG} steps ${STEPS}"
            git commit -m "${MSG}"
            git push
          fi
